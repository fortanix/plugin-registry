# JWS+JWE Decrypt

## Introduction
This plugin performs decrypt using JWE standards:  `enc:  A256CBC-HS512 alg:  RSA-OAEP-256`.

It performs the following steps:

1. It takes the JWE as input and splits it to get the parts i.e. encrypted key material, iv, ciphertext, and tag.
2. Decrypts the encrypted composite transient key using the RSA private key (provided in input), and generate AES, HMAC transient keys from the decrypted key-material.
3. Computes the `aad` from the header in the input and `al` to store the size of `aad`.
4. Using `iv` from the input, and the generated AES key, it decrypts the cipher provided in the input in `CBC` mode. We receive the plaintext after decryption, which is correct only after the verification is successful.
5. For verification, it creates an input payload for HMAC consisting of `aad, iv, cipher, al`.
6. Creates a HMAC of the payload created above using HMAC key using `SHA-512` as the hashing algorithm.
7. It truncates the digest generated above to half the length and compares it to the tag in the input.
8. If the generated digest matches the tag, then it verifies the plaintext which is a JWS.
9. It takes the JWS and splits it to get the parts i.e. header, payload, and signature.
10. From the header and payload, it re-constructs the `Jws Signing input`.
11. Decodes the signature from Base64URL to Base64, so as to use for verifying the signature.
12. Imports the `certificate` as a transient key.
13. Verifies the above constructed `Jws Signing input` and the decoded `signature` by `certificate` using `SHA-256` and mode as `PKCS1-v1_5`.
14. The plugin output is `VERIFIED` and the actual `payload` (inside the JWS) in case signature is correctly verified and `VERIFICATION FAILED` otherwise.

## Use cases
1. Assert oneâ€™s identity, given that the recipient of the JWE trusts the asserting party.
2. Transfer data securely between interested parties over a unsecured channel.

## Setup
1. For these plugin, we need a RSA private key already imported in DSM, and its corresponding public key as a certificate which the user should provide as input.

## Input/Output JSON object format
Input parameters details:

1. **`jwe`** corresponds to JWE generated by `Encrypt` plugin.
2. **`key`** is the name of `RSA` private key which should be already imported in `DSM`. This is used for decrypting the payload.
3. **`cert`** contains the contents of the certificate (`pem` file) in base64 encoding. This is used to verify the signature.

## Example usages
Sample Input format: (The certificate value should be provided as a base-64 encoded string).
```
{
    "jwe": "...",
    "key" : "keyname",
    "cert" : "..."
}
```

Sample output format:
```
{
    "payload": "...",
    "output": "VERIFIED"
}
```

## References

1. https://tools.ietf.org/html/rfc7515
2. https://tools.ietf.org/html/rfc7516